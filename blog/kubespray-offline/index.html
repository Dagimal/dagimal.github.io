<!doctype html><html lang=en-US><head><meta http-equiv=X-Clacks-Overhead content="GNU Terry Pratchett"><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><link rel="shortcut icon" href=https://dagimal.com/laptop.png><title>Kubespray Offline: Setup k8s Cluster Tanpa Koneksi Internet | Dagimal (⌐ ͡■ ͜ʖ ͡■)</title><meta name=title content="Kubespray Offline: Setup k8s Cluster Tanpa Koneksi Internet"><meta name=description content="
Kemarin sempat dibuat frustasi ketika setup cluster k8s baru di server kantor, biasanya memang kita pakai kubespray buat provisioning cluster k8s karena server kantor on-prem dan biasanya selalu lancar dan aman tanpa kendala karena memang ada koneksi internet di server, tapi kemarin dibuat bingung karena server yang mau kita setup ga ada akses internet, akhirnya setelah beberapa saat mikir dan diskusi, kita uji nyali lah coba buat private repo mirror buat keperluan setup cluster, sekalian aja karena kantor belom punya juga private mirror buat keperluan setup k8s. Setelah coba ngulik dikit di internet, ketemu script buat install k8s dengan cara offline (tetep butuh internet buat bikin mirror repo nya sih), setelah kita coba Alhamdulillah bisa dan lancar, bahkan waktu yang di butuhkan buat setup juga jauh lebih singkat daripada harus selalu download dari internet."><meta name=keywords content="container,devops,gitlab,k8s,"><meta property="og:url" content="https://dagimal.com/blog/kubespray-offline/"><meta property="og:site_name" content="Dagimal (⌐ ͡■ ͜ʖ ͡■)"><meta property="og:title" content="Kubespray Offline: Setup k8s Cluster Tanpa Koneksi Internet"><meta property="og:description" content="Kemarin sempat dibuat frustasi ketika setup cluster k8s baru di server kantor, biasanya memang kita pakai kubespray buat provisioning cluster k8s karena server kantor on-prem dan biasanya selalu lancar dan aman tanpa kendala karena memang ada koneksi internet di server, tapi kemarin dibuat bingung karena server yang mau kita setup ga ada akses internet, akhirnya setelah beberapa saat mikir dan diskusi, kita uji nyali lah coba buat private repo mirror buat keperluan setup cluster, sekalian aja karena kantor belom punya juga private mirror buat keperluan setup k8s. Setelah coba ngulik dikit di internet, ketemu script buat install k8s dengan cara offline (tetep butuh internet buat bikin mirror repo nya sih), setelah kita coba Alhamdulillah bisa dan lancar, bahkan waktu yang di butuhkan buat setup juga jauh lebih singkat daripada harus selalu download dari internet."><meta property="og:locale" content="en_US"><meta property="og:type" content="article"><meta property="article:section" content="blog"><meta property="article:published_time" content="2025-10-31T00:11:28+07:00"><meta property="article:modified_time" content="2025-10-31T00:11:28+07:00"><meta property="article:tag" content="Container"><meta property="article:tag" content="Devops"><meta property="article:tag" content="Gitlab"><meta property="article:tag" content="K8s"><meta name=twitter:card content="summary"><meta name=twitter:title content="Kubespray Offline: Setup k8s Cluster Tanpa Koneksi Internet"><meta name=twitter:description content="Kemarin sempat dibuat frustasi ketika setup cluster k8s baru di server kantor, biasanya memang kita pakai kubespray buat provisioning cluster k8s karena server kantor on-prem dan biasanya selalu lancar dan aman tanpa kendala karena memang ada koneksi internet di server, tapi kemarin dibuat bingung karena server yang mau kita setup ga ada akses internet, akhirnya setelah beberapa saat mikir dan diskusi, kita uji nyali lah coba buat private repo mirror buat keperluan setup cluster, sekalian aja karena kantor belom punya juga private mirror buat keperluan setup k8s. Setelah coba ngulik dikit di internet, ketemu script buat install k8s dengan cara offline (tetep butuh internet buat bikin mirror repo nya sih), setelah kita coba Alhamdulillah bisa dan lancar, bahkan waktu yang di butuhkan buat setup juga jauh lebih singkat daripada harus selalu download dari internet."><meta itemprop=name content="Kubespray Offline: Setup k8s Cluster Tanpa Koneksi Internet"><meta itemprop=description content="Kemarin sempat dibuat frustasi ketika setup cluster k8s baru di server kantor, biasanya memang kita pakai kubespray buat provisioning cluster k8s karena server kantor on-prem dan biasanya selalu lancar dan aman tanpa kendala karena memang ada koneksi internet di server, tapi kemarin dibuat bingung karena server yang mau kita setup ga ada akses internet, akhirnya setelah beberapa saat mikir dan diskusi, kita uji nyali lah coba buat private repo mirror buat keperluan setup cluster, sekalian aja karena kantor belom punya juga private mirror buat keperluan setup k8s. Setelah coba ngulik dikit di internet, ketemu script buat install k8s dengan cara offline (tetep butuh internet buat bikin mirror repo nya sih), setelah kita coba Alhamdulillah bisa dan lancar, bahkan waktu yang di butuhkan buat setup juga jauh lebih singkat daripada harus selalu download dari internet."><meta itemprop=datePublished content="2025-10-31T00:11:28+07:00"><meta itemprop=dateModified content="2025-10-31T00:11:28+07:00"><meta itemprop=wordCount content="1044"><meta itemprop=keywords content="Container,Devops,Gitlab,K8s"><meta name=referrer content="no-referrer-when-downgrade"><style>body{font-family:sans-serif;font-size:20px;margin:auto;padding:20px;max-width:1e3px;text-align:left;background-color:#fff;word-wrap:break-word;overflow-wrap:break-word;line-height:1.5;color:#000}h1,h2,h3,h4,h5,h6,strong,b{color:#000}a{color:#0101ee}.title{text-decoration:none;border:0}.title span{font-weight:400}nav a{margin-right:10px}textarea{width:100%;font-size:18px}input{font-size:18px}content{line-height:1.6}table{width:100%}img{max-width:100%}code{padding:2px 5px;background-color:#f2f2f2}pre code{color:#000;display:block;padding:20px;white-space:pre-wrap;font-size:18px;overflow-x:auto}div.highlight pre{background-color:initial;color:initial}div.highlight code{background-color:unset;color:unset}blockquote{border-left:1px solid #999;color:#222;padding-left:20px;font-style:italic}footer{padding:25px;text-align:center}.helptext{color:#777;font-size:small}.errorlist{color:#eba613;font-size:small}ul.blog-posts{list-style-type:none;padding:unset}ul.blog-posts li{display:flex}ul.blog-posts li span{flex:0 0 130px}ul.blog-posts li a:visited{color:#8b6fcb}@media(prefers-color-scheme:dark){body{background-color:#333;color:#ddd}h1,h2,h3,h4,h5,h6,strong,b{color:#eee}a{color:#8cc2dd}code{background-color:#777}pre code{color:#ddd}blockquote{color:#ccc}textarea,input{background-color:#252525;color:#ddd}.helptext{color:#aaa}}</style><meta property="og:type" content="article"><meta property="og:title" content="Kubespray Offline: Setup k8s Cluster Tanpa Koneksi Internet"><meta property="og:description" content="
Kemarin sempat dibuat frustasi ketika setup cluster k8s baru di server kantor, biasanya memang kita pakai kubespray buat provisioning cluster k8s karena server kantor on-prem dan biasanya selalu lancar dan aman tanpa kendala karena memang ada koneksi internet di server, tapi kemarin dibuat bingung karena server yang mau kita setup ga ada akses internet, akhirnya setelah beberapa saat mikir dan diskusi, kita uji nyali lah coba buat private repo mirror buat keperluan setup cluster, sekalian aja karena kantor belom punya juga private mirror buat keperluan setup k8s. Setelah coba ngulik dikit di internet, ketemu script buat install k8s dengan cara offline (tetep butuh internet buat bikin mirror repo nya sih), setelah kita coba Alhamdulillah bisa dan lancar, bahkan waktu yang di butuhkan buat setup juga jauh lebih singkat daripada harus selalu download dari internet."><meta property="og:url" content="https://dagimal.com/blog/kubespray-offline/"><meta property="og:image" content="default.png"><meta property="og:site_name" content="Dagimal (⌐ ͡■ ͜ʖ ͡■)"><meta property="og:locale" content="id_ID"><meta name=twitter:card content="summary_large_image"><meta name=twitter:title content="Kubespray Offline: Setup k8s Cluster Tanpa Koneksi Internet"><meta name=twitter:description content="
Kemarin sempat dibuat frustasi ketika setup cluster k8s baru di server kantor, biasanya memang kita pakai kubespray buat provisioning cluster k8s karena server kantor on-prem dan biasanya selalu lancar dan aman tanpa kendala karena memang ada koneksi internet di server, tapi kemarin dibuat bingung karena server yang mau kita setup ga ada akses internet, akhirnya setelah beberapa saat mikir dan diskusi, kita uji nyali lah coba buat private repo mirror buat keperluan setup cluster, sekalian aja karena kantor belom punya juga private mirror buat keperluan setup k8s. Setelah coba ngulik dikit di internet, ketemu script buat install k8s dengan cara offline (tetep butuh internet buat bikin mirror repo nya sih), setelah kita coba Alhamdulillah bisa dan lancar, bahkan waktu yang di butuhkan buat setup juga jauh lebih singkat daripada harus selalu download dari internet."><meta name=twitter:image content="default.png"></head><body><header><a href=/ class=title><h2>Dagimal (⌐ ͡■ ͜ʖ ͡■)</h2></a><nav><a href=/>Home</a>
<a href=/blog>Blog</a></nav></header><main><h1>Kubespray Offline: Setup k8s Cluster Tanpa Koneksi Internet</h1><p><i><time datetime=2025-10-31 pubdate>31 Oct, 2025</time></i></p><content><img alt=kubespray-failed src=/img/kubespray-failed.png><p>Kemarin sempat dibuat frustasi ketika setup cluster k8s baru di server kantor, biasanya memang kita pakai kubespray buat provisioning cluster k8s karena server kantor on-prem dan biasanya selalu lancar dan aman tanpa kendala karena memang ada koneksi internet di server, tapi kemarin dibuat bingung karena server yang mau kita setup ga ada akses internet, akhirnya setelah beberapa saat mikir dan diskusi, kita uji nyali lah coba buat private repo mirror buat keperluan setup cluster, sekalian aja karena kantor belom punya juga private mirror buat keperluan setup k8s. Setelah coba ngulik dikit di internet, ketemu script buat install k8s dengan cara offline (tetep butuh internet buat bikin mirror repo nya sih), setelah kita coba Alhamdulillah bisa dan lancar, bahkan waktu yang di butuhkan buat setup juga jauh lebih singkat daripada harus selalu download dari internet.</p><p><em><strong>Disclaimer : Saya asumsikan kalian sudah pernah menggunakan kubespray sebelumnya</strong></em></p><blockquote><p><a href=https://github.com/kubespray-offline/kubespray-offline>https://github.com/kubespray-offline/kubespray-offline</a></p></blockquote><h3 id=persiapan>Persiapan</h3><p>Sebelum kita mulai instalasi, pastikan hal - hal berikut:</p><ul><li>Punya mesin yang <em><strong>internet accessible</strong></em>, maksudnya adalah mesin yang ada akses internet buat download semua utilitas yang diperlukan untuk setup k8s. Terserah mau pakai server jumphost atau pakai host laptop kita sendiri juga bisa.</li><li>Mesin target <em><strong>(cluster on-prem)</strong></em> yang tidak punya akses ke internet (jelas dong, kalo ga ada mau install dimana)</li><li>Sistem operasi untuk menjalankan kubespray-offline, sementara sampai panduan ini ditulis, kubespray-offline baru support untuk Keluarga OS GNU/Linux berikut :<ul><li>RHEL / AlmaLinux / Rocky Linux : 9.</li><li>Ubuntu 22.04 / 24.04.</li></ul></li><li>Pastikan juga mesin untuk menjalankan kubespray bisa terhubung ke target node.</li><li>Mesin untuk mirror repo / registry <strong>(opsional, bisa menggunakan mesin yang sama)</strong></li></ul><h3 id=instalasi>Instalasi</h3><ol><li><p>langkah pertama, langsung aja clone repo nya</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>git clone https://github.com/kubespray-offline/kubespray-offline.git
</span></span></code></pre></div></li><li><p>Install container tools<br>Fungsi dari container tools adalah untuk download / pull image yang dibutuhkan k8s.<br>karena saya mau pakai docker, download dulu dockernya dengan menjalankan script :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./install-docker.sh
</span></span></code></pre></div><p>alasan menggunakan docker karena praktis, sudah satu paket dengan containerd, jika kalian ga mau pakai docker bisa pilih menggunakan podman atau nerdctl, tapi kalau nerdctl harus download containerd nya secara terpisah, scriptnya sudah tersedia juga.</p></li><li><p>Edit file <code>config.sh</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e>#!/bin/bash
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>source ./target-scripts/config.sh
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># container runtime for preparation node</span>
</span></span><span style=display:flex><span>docker<span style=color:#f92672>=</span><span style=color:#e6db74>${</span>docker<span style=color:#66d9ef>:-</span>podman<span style=color:#e6db74>}</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#docker=${docker:-docker}</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#docker=${docker:-/usr/local/bin/nerdctl}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Run ansible in container?</span>
</span></span><span style=display:flex><span>ansible_in_container<span style=color:#f92672>=</span><span style=color:#e6db74>${</span>ansible_in_container<span style=color:#66d9ef>:-</span>false<span style=color:#e6db74>}</span>
</span></span></code></pre></div><p>Silahkan sesuaikan saja mau pakai yang mana, fungsinya hanya untuk download / pulling image yang dibutuhkan pada saat proses setup cluster, contoh:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>docker<span style=color:#f92672>=</span><span style=color:#e6db74>${</span>docker<span style=color:#66d9ef>:-</span>podman<span style=color:#e6db74>}</span>
</span></span></code></pre></div><p>artinya, jika docker belum terinstall / tidak tersedia di environment, maka dia akan menggunakan alternatifnya yaitu podman. Karena saya sudah menginstall docker pada langkah sebelumnya, maka biarkan dia memilih docker sebagai default container tools.</p></li><li><p>Jalankan script untuk download semua artefak yang dibutuhkan</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./download-all.sh
</span></span></code></pre></div><p>semua artefak yang ter-download akan disimpan pada direktori <code>outputs</code>. Di dalam <code>outputs</code> akan ada beberapa script dan folder :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>root@crm-gitlab-runner-stg:~/kubespray-offline/outputs# ll
</span></span><span style=display:flex><span>total <span style=color:#ae81ff>108</span>
</span></span><span style=display:flex><span>drwxr-xr-x <span style=color:#ae81ff>10</span> root root <span style=color:#ae81ff>4096</span> Nov  <span style=color:#ae81ff>2</span> 01:43 ./
</span></span><span style=display:flex><span>drwxr-xr-x <span style=color:#ae81ff>16</span> root root <span style=color:#ae81ff>4096</span> Oct <span style=color:#ae81ff>28</span> 03:52 ../
</span></span><span style=display:flex><span>-rw-r--r--  <span style=color:#ae81ff>1</span> root root  <span style=color:#ae81ff>777</span> Oct <span style=color:#ae81ff>28</span> 03:59 config.sh
</span></span><span style=display:flex><span>-rw-r--r--  <span style=color:#ae81ff>1</span> root root  <span style=color:#ae81ff>778</span> Oct <span style=color:#ae81ff>28</span> 03:49 config.sht
</span></span><span style=display:flex><span>-rw-r--r--  <span style=color:#ae81ff>1</span> root root  <span style=color:#ae81ff>647</span> Oct <span style=color:#ae81ff>28</span> 03:08 config.toml
</span></span><span style=display:flex><span>-rw-r--r--  <span style=color:#ae81ff>1</span> root root <span style=color:#ae81ff>1270</span> Oct <span style=color:#ae81ff>28</span> 03:08 containerd.service
</span></span><span style=display:flex><span>drwxr-xr-x  <span style=color:#ae81ff>3</span> root root <span style=color:#ae81ff>4096</span> Oct <span style=color:#ae81ff>28</span> 03:08 debs/
</span></span><span style=display:flex><span>-rwxr-xr-x  <span style=color:#ae81ff>1</span> root root  <span style=color:#ae81ff>719</span> Oct <span style=color:#ae81ff>28</span> 03:08 extract-kubespray.sh*
</span></span><span style=display:flex><span>drwxr-xr-x  <span style=color:#ae81ff>8</span> root root <span style=color:#ae81ff>4096</span> Oct <span style=color:#ae81ff>28</span> 02:56 files/
</span></span><span style=display:flex><span>drwxr-xr-x  <span style=color:#ae81ff>2</span> root root <span style=color:#ae81ff>4096</span> Oct <span style=color:#ae81ff>28</span> 03:05 images/
</span></span><span style=display:flex><span>-rwxr-xr-x  <span style=color:#ae81ff>1</span> root root <span style=color:#ae81ff>2480</span> Oct <span style=color:#ae81ff>28</span> 03:08 install-containerd.sh*
</span></span><span style=display:flex><span>drwxrwxr-x <span style=color:#ae81ff>19</span> root root <span style=color:#ae81ff>4096</span> Oct <span style=color:#ae81ff>28</span> 09:16 kubespray-2.29.0/
</span></span><span style=display:flex><span>-rwxr-xr-x  <span style=color:#ae81ff>1</span> root root <span style=color:#ae81ff>1034</span> Oct <span style=color:#ae81ff>28</span> 03:08 load-push-all-images.sh*
</span></span><span style=display:flex><span>-rw-r--r--  <span style=color:#ae81ff>1</span> root root  <span style=color:#ae81ff>349</span> Oct <span style=color:#ae81ff>28</span> 04:28 nginx-default.conf
</span></span><span style=display:flex><span>drwxr-xr-x  <span style=color:#ae81ff>3</span> root root <span style=color:#ae81ff>4096</span> Oct <span style=color:#ae81ff>28</span> 03:08 patches/
</span></span><span style=display:flex><span>drwxr-xr-x  <span style=color:#ae81ff>3</span> root root <span style=color:#ae81ff>4096</span> Oct <span style=color:#ae81ff>28</span> 03:08 playbook/
</span></span><span style=display:flex><span>drwxr-xr-x <span style=color:#ae81ff>24</span> root root <span style=color:#ae81ff>4096</span> Oct <span style=color:#ae81ff>28</span> 02:56 pypi/
</span></span><span style=display:flex><span>-rw-r--r--  <span style=color:#ae81ff>1</span> root root  <span style=color:#ae81ff>607</span> Oct <span style=color:#ae81ff>28</span> 03:08 pyver.sh
</span></span><span style=display:flex><span>-rwxr-xr-x  <span style=color:#ae81ff>1</span> root root  <span style=color:#ae81ff>394</span> Oct <span style=color:#ae81ff>28</span> 03:08 setup-all.sh*
</span></span><span style=display:flex><span>-rwxr-xr-x  <span style=color:#ae81ff>1</span> root root  <span style=color:#ae81ff>408</span> Oct <span style=color:#ae81ff>28</span> 03:08 setup-container.sh*
</span></span><span style=display:flex><span>-rwxr-xr-x  <span style=color:#ae81ff>1</span> root root <span style=color:#ae81ff>2106</span> Oct <span style=color:#ae81ff>28</span> 03:08 setup-offline.sh*
</span></span><span style=display:flex><span>-rwxr-xr-x  <span style=color:#ae81ff>1</span> root root <span style=color:#ae81ff>1213</span> Oct <span style=color:#ae81ff>28</span> 03:08 setup-py.sh*
</span></span><span style=display:flex><span>-rwxr-xr-x  <span style=color:#ae81ff>1</span> root root  <span style=color:#ae81ff>654</span> Oct <span style=color:#ae81ff>28</span> 03:08 start-nginx.sh*
</span></span><span style=display:flex><span>-rwxr-xr-x  <span style=color:#ae81ff>1</span> root root  <span style=color:#ae81ff>890</span> Oct <span style=color:#ae81ff>28</span> 08:21 start-registry-docker.sh*
</span></span><span style=display:flex><span>-rwxr-xr-x  <span style=color:#ae81ff>1</span> root root  <span style=color:#ae81ff>445</span> Oct <span style=color:#ae81ff>28</span> 03:08 start-registry.sh*
</span></span><span style=display:flex><span>drwxr-xr-x  <span style=color:#ae81ff>3</span> root root <span style=color:#ae81ff>4096</span> Oct <span style=color:#ae81ff>28</span> 03:08 tmp/
</span></span><span style=display:flex><span>-rw-r--r--  <span style=color:#ae81ff>1</span> root root  <span style=color:#ae81ff>322</span> Oct <span style=color:#ae81ff>28</span> 03:08 venv.sh
</span></span></code></pre></div></li></ol><h3 id=install-kubespray-dan-virtual-environment>Install Kubespray dan Virtual Environment</h3><p>Fungsi dari Virtual Environment (venv), adalah untuk mengisolasi environment python, agar apa yang kita lakukan di lingkungan python tidak terpengaruh di lingkungan host kita, untuk meminimalisir kemungkinan paket konflik.</p><ul><li><p>Jalankan script di dalam direktori <code>outputs</code><br></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./extract-kubespray.sh
</span></span></code></pre></div></li><li><p>Buat dan aktifkan virtual environment :
Sesuaikan versi python yang terinstall pada sistem dengan mengubah variabel <code>PY=</code> pada file <code>target-scripts/pyver.sh</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>python3 -m venv ~/.venv/&lt;python-version&gt;
</span></span><span style=display:flex><span>source ~/.venv/&lt;python-version&gt;/bin/activate
</span></span></code></pre></div><p>Jika virtual environment sudah aktif, akan muncul tanda (venv) pada shell seperti berikut :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#f92672>(</span>venv<span style=color:#f92672>)</span> root@crm-gitlab-runner-stg:~/kubespray-offline/outputs#
</span></span></code></pre></div></li><li><p>Install ansible</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pip install -U pip <span style=color:#75715e># update versi pip</span>
</span></span><span style=display:flex><span>pip install -r requirements.txt <span style=color:#75715e># install ansible</span>
</span></span></code></pre></div></li></ul><h3 id=buat-mirror-server--registry>Buat Mirror Server / Registry</h3><p>Setelah semua artefak ter-download, langkah selanjutnya adalah membuat mirror server untuk package kubernetes, seperti mirror deb dan container registry</p><ol><li><p>Copy semua isi direktori <code>outputs</code> ke server yang akan kita buat server mirror <em><strong>(skip saja jika menggunakan server yang sama)</strong></em></p></li><li><p>Edit <code>config.sh</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e>#!/bin/bash
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#75715e># Kubespray version to download. Use &#34;master&#34; for latest master branch.</span>
</span></span><span style=display:flex><span>KUBESPRAY_VERSION<span style=color:#f92672>=</span><span style=color:#e6db74>${</span>KUBESPRAY_VERSION<span style=color:#66d9ef>:-</span>2.29.0<span style=color:#e6db74>}</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#KUBESPRAY_VERSION=${KUBESPRAY_VERSION:-master}</span>
</span></span><span style=display:flex><span>NGINX_PORT<span style=color:#f92672>=</span><span style=color:#ae81ff>80</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Versions of containerd related binaries used in `install-containerd.sh`</span>
</span></span><span style=display:flex><span><span style=color:#75715e># These version must be same as kubespray.</span>
</span></span><span style=display:flex><span><span style=color:#75715e># Refer `roles/kubespray_defaults/vars/main/checksums.yml` of kubespray.</span>
</span></span><span style=display:flex><span>RUNC_VERSION<span style=color:#f92672>=</span>1.3.2
</span></span><span style=display:flex><span>CONTAINERD_VERSION<span style=color:#f92672>=</span>2.1.4
</span></span><span style=display:flex><span>NERDCTL_VERSION<span style=color:#f92672>=</span>2.1.6
</span></span><span style=display:flex><span>CNI_VERSION<span style=color:#f92672>=</span>1.8.0
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Some container versions, must be same as ../imagelists/images.txt</span>
</span></span><span style=display:flex><span>NGINX_VERSION<span style=color:#f92672>=</span>1.29.2
</span></span><span style=display:flex><span>REGISTRY_VERSION<span style=color:#f92672>=</span>2.8.3
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># container registry port</span>
</span></span><span style=display:flex><span>REGISTRY_PORT<span style=color:#f92672>=</span><span style=color:#e6db74>${</span>REGISTRY_PORT<span style=color:#66d9ef>:-</span>35000<span style=color:#e6db74>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Additional container registry hosts</span>
</span></span><span style=display:flex><span>ADDITIONAL_CONTAINER_REGISTRY_LIST<span style=color:#f92672>=</span><span style=color:#e6db74>${</span>ADDITIONAL_CONTAINER_REGISTRY_LIST<span style=color:#66d9ef>:-</span><span style=color:#e6db74>&#34;myregistry.io&#34;</span><span style=color:#e6db74>}</span>
</span></span></code></pre></div><p>Sesuaikan versi kubespray yang kita gunakan pada langkah sebelumnya.</p></li><li><p>Masih pada folder <code>outputs</code>, jalankan script berikut :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./start-nginx.sh
</span></span><span style=display:flex><span>./start-registry.sh
</span></span></code></pre></div><p>script tersebut akan menjalankan :</p><ul><li>menjalankan nginx container untuk membuat repo lokal (DEB/RPM)</li><li>menjalankan private registry container</li></ul></li><li><p>Push image ke private registry</p><pre tabindex=0><code>./load-push-all-images.sh
</code></pre><p>script ini akan melakukan push semua image yang telah kita download ke private registry yang sudah kita buat.</p></li></ol><h3 id=offline-ansible-config>Offline Ansible Config</h3><ol><li><p>Copy file <code>offline.yml</code> dari direktori <code>kubespray-offline</code> ke direktori inventory</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>cp offline.yml kubespray-&lt;version&gt;/inventory/mycluster/group_vars/all/
</span></span></code></pre></div></li><li><p>Ganti <code>YOUR_HOST</code> menjadi host server mirror kita.</p></li></ol><h3 id=deploy-offline-repo>Deploy Offline Repo</h3><p>Setelah mirror server ready, langkah selanjutnya adalah config semua server target untuk menggunakan mirror server yang sudah kita buat.</p><ol><li><p>Copy script ke direktori kubespray</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>cp -r outputs/playbook kubespray-&lt;version&gt;
</span></span></code></pre></div></li><li><p>Deploy repo</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>ansible-playbook -i inventory/mycluster/hosts.yaml playbook/offline-repo.yml
</span></span></code></pre></div></li></ol><h3 id=spray>Spray!</h3><ul><li>Ini langkah terakhir, jalankan seperti biasa kita deploy cluster k8s<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>ansible-playbook -i inventory/mycluster/hosts.yaml  --become --become-user<span style=color:#f92672>=</span>root cluster.yml
</span></span></code></pre></div></li></ul><p>Alhamdulillah, cluster sudah ready dan siap untuk menjalankan workload aplikasi.</p><blockquote><img alt=kubespray-failed src=/img/ready-cluster.png></blockquote></content></main><footer>Ditulis dengan {❤️} di Klaten - Jakarta</footer></body></html>